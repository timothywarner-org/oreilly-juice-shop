openapi: 3.0.0
servers:
  - url: /b2b/v2
    description: Production B2B API v2 (JSON-based)

info:
  version: 2.0.0
  title: 'NextGen B2B API'
  description: |
    New & secure JSON-based API for our enterprise customers.
    
    This API replaces the previously offered XML-based endpoints with modern JSON REST endpoints.
    
    ## Authentication
    All endpoints require JWT bearer token authentication unless explicitly marked as public.
    
    ## Versioning
    This is version 2.0 of our B2B API. The version is included in the base path (/b2b/v2).
    Breaking changes will result in a new major version.
    
    ## Rate Limiting
    - Standard tier: 1000 requests per hour
    - Premium tier: 10000 requests per hour
    Rate limit information is returned in response headers.
    
    ## Support
    For technical support, please contact our B2B API team.
  license:
    name: MIT
    url: 'https://opensource.org/licenses/MIT'
  contact:
    name: B2B API Support
    email: b2b-api-support@example.com
    url: 'https://example.com/support/b2b-api'

tags:
  - name: Order
    description: 'API endpoints for customer order management'
  - name: System
    description: 'System health and monitoring endpoints'

paths:
  /health:
    get:
      operationId: healthCheck
      tags: [System]
      security: []  # Public endpoint - no authentication required
      summary: 'API health check'
      description: 'Check API availability and health status for monitoring systems'
      responses:
        '200':
          description: 'API is operational'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
              example:
                status: 'healthy'
                version: '2.0.0'
                timestamp: '2025-12-01T18:47:53.034Z'
        '503':
          description: 'Service Unavailable - API is unhealthy'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
              example:
                status: 'unhealthy'
                version: '2.0.0'
                timestamp: '2025-12-01T18:47:53.034Z'

  /orders:
    post:
      operationId: createCustomerOrder
      tags: [Order]
      summary: 'Create a new customer order'
      description: |
        Create a new customer order with either standard JSON format (orderLines)
        or customer-specific format (orderLinesData).
        
        **Note:** Use either `orderLines` OR `orderLinesData`, not both.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        description: 'Customer order to be placed'
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Order'
            examples:
              standardOrder:
                summary: 'Standard order with orderLines array'
                value:
                  cid: 'JS0815DE'
                  orderLines:
                    - productId: 8
                      quantity: 500
                      customerReference: 'PO0000001'
                    - productId: 12
                      quantity: 250
                      customerReference: 'PO0000002'
              customFormatOrder:
                summary: 'Custom format order with orderLinesData string'
                description: 'For customers with legacy systems requiring specific JSON format'
                value:
                  cid: 'JS0815DE'
                  orderLinesData: '[{"productId": 12,"quantity": 10000,"customerReference": ["PO0000001.2", "SM20180105|042"],"couponCode": "pes[Bh.u*t"}},{"productId": 13,"quantity": 2000}]'
      responses:
        '200':
          description: 'Order successfully created'
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: 'Request limit per time window'
              example: 1000
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: 'Remaining requests in current window'
              example: 999
            X-RateLimit-Reset:
              schema:
                type: integer
              description: 'Unix timestamp when limit resets'
              example: 1733079473
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderConfirmation'
              example:
                cid: 'JS0815DE'
                orderNo: '3d06ac5e1bdf39d26392f8100f124742'
                paymentDue: '2025-12-15'
        '400':
          description: 'Bad Request - Invalid order data or malformed JSON'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'Bad Request'
                message: 'Invalid order data: quantity must be at least 1'
                code: 'INVALID_ORDER_DATA'
        '401':
          description: 'Unauthorized - Invalid or missing JWT token'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'Unauthorized'
                message: 'Invalid or expired JWT token'
                code: 'AUTH_FAILED'
        '403':
          description: 'Forbidden - Customer ID does not match authenticated user'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'Forbidden'
                message: 'Customer ID in request does not match authenticated customer'
                code: 'CUSTOMER_MISMATCH'
        '422':
          description: 'Unprocessable Entity - Validation failed'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                error: 'Validation Failed'
                message: 'One or more fields failed validation'
                code: 'VALIDATION_ERROR'
                validationErrors:
                  - field: 'cid'
                    message: 'Customer ID must match pattern ^[A-Z]{2}[0-9]{4}[A-Z]{2}$'
                  - field: 'orderLines[0].quantity'
                    message: 'Quantity must be between 1 and 1000000'
        '429':
          description: 'Too Many Requests - Rate limit exceeded'
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Reset:
              schema:
                type: integer
              description: 'Unix timestamp when you can retry'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'Too Many Requests'
                message: 'Rate limit exceeded. Please retry after reset time.'
                code: 'RATE_LIMIT_EXCEEDED'
        '500':
          description: 'Internal Server Error - Unexpected server error'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'Internal Server Error'
                message: 'An unexpected error occurred while processing your request'
                code: 'INTERNAL_ERROR'

    get:
      operationId: listCustomerOrders
      tags: [Order]
      summary: 'List customer orders'
      description: |
        Retrieve a paginated list of orders for the authenticated customer.
        Results are sorted by creation date (most recent first).
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: 'Page number (1-based)'
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
        - name: limit
          in: query
          description: 'Number of items per page'
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: status
          in: query
          description: 'Filter orders by status'
          required: false
          schema:
            type: string
            enum: [pending, confirmed, shipped, delivered, cancelled]
          example: 'confirmed'
        - name: fromDate
          in: query
          description: 'Filter orders created on or after this date'
          required: false
          schema:
            type: string
            format: date
          example: '2025-01-01'
        - name: toDate
          in: query
          description: 'Filter orders created on or before this date'
          required: false
          schema:
            type: string
            format: date
          example: '2025-12-31'
      responses:
        '200':
          description: 'List of customer orders'
          headers:
            Cache-Control:
              schema:
                type: string
              description: 'Cache control directives'
              example: 'max-age=60, private'
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderList'
              example:
                data:
                  - cid: 'JS0815DE'
                    orderNo: '3d06ac5e1bdf39d26392f8100f124742'
                    paymentDue: '2025-12-15'
                    status: 'confirmed'
                    createdAt: '2025-12-01T10:30:00Z'
                  - cid: 'JS0815DE'
                    orderNo: 'f1e2d3c4b5a6978869504132a1b2c3d4'
                    paymentDue: '2025-12-10'
                    status: 'shipped'
                    createdAt: '2025-11-26T14:22:00Z'
                pagination:
                  page: 1
                  limit: 20
                  total: 2
                  totalPages: 1
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /orders/batch:
    post:
      operationId: createBatchOrders
      tags: [Order]
      summary: 'Create multiple orders in a single request'
      description: |
        Create multiple customer orders in a single API call for improved performance.
        Maximum 100 orders per request.
        
        All orders must be for the same customer (matching authenticated cid).
      security:
        - bearerAuth: []
      requestBody:
        required: true
        description: 'Batch of customer orders to be placed'
        content:
          application/json:
            schema:
              type: object
              required: [orders]
              properties:
                orders:
                  type: array
                  minItems: 1
                  maxItems: 100
                  items:
                    $ref: '#/components/schemas/Order'
            example:
              orders:
                - cid: 'JS0815DE'
                  orderLines:
                    - productId: 8
                      quantity: 500
                - cid: 'JS0815DE'
                  orderLines:
                    - productId: 12
                      quantity: 250
      responses:
        '200':
          description: 'Batch orders processed'
          content:
            application/json:
              schema:
                type: object
                properties:
                  successful:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderConfirmation'
                  failed:
                    type: array
                    items:
                      type: object
                      properties:
                        index:
                          type: integer
                          description: 'Index of failed order in request array'
                        order:
                          $ref: '#/components/schemas/Order'
                        error:
                          type: string
                          description: 'Error message'
              example:
                successful:
                  - cid: 'JS0815DE'
                    orderNo: '3d06ac5e1bdf39d26392f8100f124742'
                    paymentDue: '2025-12-15'
                failed: []
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /orders/{orderNo}:
    get:
      operationId: getOrderDetails
      tags: [Order]
      summary: 'Get order details by order number'
      description: 'Retrieve detailed information about a specific order'
      security:
        - bearerAuth: []
      parameters:
        - name: orderNo
          in: path
          required: true
          description: 'Unique order number'
          schema:
            type: string
            pattern: '^[a-f0-9]{32}$'
          example: '3d06ac5e1bdf39d26392f8100f124742'
      responses:
        '200':
          description: 'Order details retrieved successfully'
          headers:
            Cache-Control:
              schema:
                type: string
              example: 'max-age=300, private'
            ETag:
              schema:
                type: string
              description: 'Entity tag for cache validation'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderConfirmation'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: 'Order not found'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: 'Not Found'
                message: 'Order with number 3d06ac5e1bdf39d26392f8100f124742 not found'
                code: 'ORDER_NOT_FOUND'
        '429':
          $ref: '#/components/responses/RateLimitError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token required for authentication.
        
        **Token Claims:**
        - `userId`: Unique user identifier
        - `cid`: Customer ID
        - `exp`: Expiration timestamp
        - `iat`: Issued at timestamp
        
        **Token Expiration:** Tokens expire after 1 hour.
        
        **Usage:** Include token in Authorization header:
        ```
        Authorization: Bearer <your-jwt-token>
        ```

  schemas:
    Order:
      type: object
      required: [cid]
      properties:
        cid:
          type: string
          pattern: '^[A-Z]{2}[0-9]{4}[A-Z]{2}$'
          minLength: 8
          maxLength: 8
          example: 'JS0815DE'
          description: 'Customer identifier in format: 2 uppercase letters, 4 digits, 2 uppercase letters'
        orderLines:
          $ref: '#/components/schemas/OrderLines'
        orderLinesData:
          $ref: '#/components/schemas/OrderLinesData'
      description: |
        Customer order representation.
        
        **Important:** Provide EITHER `orderLines` (standard format) OR `orderLinesData` (custom format), not both.
        - Use `orderLines` for standard JSON format (recommended for most customers)
        - Use `orderLinesData` only if you have a legacy system requiring custom JSON format

    OrderConfirmation:
      type: object
      required: [cid, orderNo, paymentDue]
      properties:
        cid:
          type: string
          pattern: '^[A-Z]{2}[0-9]{4}[A-Z]{2}$'
          example: 'JS0815DE'
          description: 'Customer identifier'
        orderNo:
          type: string
          pattern: '^[a-f0-9]{32}$'
          example: '3d06ac5e1bdf39d26392f8100f124742'
          description: 'Unique order number (32-character hexadecimal identifier)'
        paymentDue:
          type: string
          format: date
          example: '2025-12-15'
          description: 'Payment due date (14 days after order placement)'
        status:
          type: string
          enum: [pending, confirmed, shipped, delivered, cancelled]
          example: 'confirmed'
          description: 'Current order status'
        createdAt:
          type: string
          format: date-time
          example: '2025-12-01T10:30:00Z'
          description: 'Timestamp when order was created'
      description: 'Order confirmation details returned after successful order creation'

    OrderLine:
      type: object
      required: [productId, quantity]
      properties:
        productId:
          type: integer
          minimum: 1
          example: 8
          description: 'Unique identifier for the product from product catalog'
        quantity:
          type: integer
          minimum: 1
          maximum: 1000000
          example: 500
          description: 'Number of units to order (must be between 1 and 1,000,000)'
        customerReference:
          type: string
          maxLength: 50
          pattern: '^[A-Z]{2}[0-9]{6,7}(\.[0-9]+)?$'
          example: 'PO0000001'
          description: 'Customer purchase order reference or internal tracking number'
      description: 'Individual line item in an order using standard JSON format'

    OrderLines:
      type: array
      minItems: 1
      maxItems: 1000
      items:
        $ref: '#/components/schemas/OrderLine'
      description: 'Array of order line items (maximum 1000 items per order)'

    OrderLinesData:
      type: string
      maxLength: 1000000
      example: '[{"productId": 12,"quantity": 10000,"customerReference": ["PO0000001.2", "SM20180105|042"],"couponCode": "pes[Bh.u*t"}},{"productId": 13,"quantity": 2000,"customerReference": "PO0000003.4"}]'
      description: |
        Order line(s) in customer-specific JSON format (provided as a JSON string).
        
        **Note:** This field is for legacy customers only. New integrations should use `orderLines` instead.
        The string will be parsed and validated on the server side.

    OrderList:
      type: object
      required: [data, pagination]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OrderConfirmation'
          description: 'Array of order confirmations'
        pagination:
          $ref: '#/components/schemas/Pagination'
      description: 'Paginated list of orders'

    Pagination:
      type: object
      required: [page, limit, total, totalPages]
      properties:
        page:
          type: integer
          minimum: 1
          description: 'Current page number'
          example: 1
        limit:
          type: integer
          minimum: 1
          maximum: 100
          description: 'Number of items per page'
          example: 20
        total:
          type: integer
          minimum: 0
          description: 'Total number of items across all pages'
          example: 150
        totalPages:
          type: integer
          minimum: 0
          description: 'Total number of pages'
          example: 8
      description: 'Pagination metadata for list responses'

    Error:
      type: object
      required: [error, message, code]
      properties:
        error:
          type: string
          description: 'Error title'
          example: 'Bad Request'
        message:
          type: string
          description: 'Human-readable error message'
          example: 'Invalid order data provided'
        code:
          type: string
          description: 'Machine-readable error code for programmatic handling'
          example: 'INVALID_ORDER_DATA'
        timestamp:
          type: string
          format: date-time
          description: 'When the error occurred'
          example: '2025-12-01T18:47:53.034Z'
        requestId:
          type: string
          description: 'Unique request identifier for debugging'
          example: 'req_abc123xyz'
      description: 'Standard error response format'

    ValidationError:
      type: object
      required: [error, message, code, validationErrors]
      properties:
        error:
          type: string
          example: 'Validation Failed'
        message:
          type: string
          example: 'One or more fields failed validation'
        code:
          type: string
          example: 'VALIDATION_ERROR'
        validationErrors:
          type: array
          items:
            type: object
            required: [field, message]
            properties:
              field:
                type: string
                description: 'Field name that failed validation'
                example: 'orderLines[0].quantity'
              message:
                type: string
                description: 'Validation error message'
                example: 'Quantity must be at least 1'
              code:
                type: string
                description: 'Validation error code'
                example: 'MIN_VALUE'
      description: 'Validation error response with detailed field-level errors'

    HealthStatus:
      type: object
      required: [status, version, timestamp]
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: 'Current health status of the API'
          example: 'healthy'
        version:
          type: string
          description: 'API version'
          example: '2.0.0'
        timestamp:
          type: string
          format: date-time
          description: 'Current server timestamp'
          example: '2025-12-01T18:47:53.034Z'
        uptime:
          type: integer
          description: 'Server uptime in seconds'
          example: 86400
      description: 'API health status response'

  responses:
    BadRequestError:
      description: 'Bad Request - Invalid request data'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    UnauthorizedError:
      description: 'Unauthorized - Authentication required'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    ValidationError:
      description: 'Validation Failed - One or more fields failed validation'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'

    RateLimitError:
      description: 'Too Many Requests - Rate limit exceeded'
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Reset:
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalServerError:
      description: 'Internal Server Error'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

security:
  - bearerAuth: []
